#!/usr/bin/env bash

git-sync() {
    # Add, commit, push functions and aliases.
    # Hopefully safely
    
    local repo="${HOME}/gits/bashrc_stuff"

    # move to working dir 
    [[ "$(pwd)" != "$repo" ]] && pushd "$repo" >/dev/null 2>&1

    # ensure stash is clean
    [[ -n "$(git stash list)" ]] && git stash drop

    # stash changes (if any) & sync with github repo
    git stash >/dev/null 2>&1
    git pull

    # apply stash (if any)
    [[ -n "$(git stash list)" ]] && git stash apply

    # Add all, commit, push
    git add -A
    git commit -m "auto commited on: $(date -I'ns')"
    git push origin master

    # Good push? Drop the stash
    [[ "$?" -eq 0 ]] && git stash drop

    # Return to origin dir
    popd >/dev/null 2>&1

    # Source updated .bashrc
    unalias -a && . ${HOME}/.bashrc
}

spectre() {
    # Modified spectre wrapper
    _copy() {
        _clips=('pbcopy' 'xclip' 'gpaste-client')
        _use="${_clips[2]}"

        case "$_use" in
            "${_clips[0]}")
                hash "$_use" 2>/dev/null && "$_use" ;;
            "${_clips[1]}")
                hash "$_use" 2>/dev/null && "$_use" ;;
            "${_clips[2]}")
                hash "$_use" 2>/dev/null && "$_use" add-password "" ;;
            *)
                cat; echo 2>/dev/null
                return
        esac

        echo >&2 "Copied!"
    }

    if [[ "$1" =~ (-h|--help) ]]; then
	      # Call the binary directly when passing help flag so we
	      # don't get ugly output and duplicate output with pager
	      if [[ ! -f /tmp/spectre_help ]]; then

	          ${HOME}/bin/spectre -h > /tmp/spectre_help 2>&1

	      fi
	      
	      less /tmp/spectre_help
    else
 	      # Empty the clipboard.
	      :| _copy 2>/dev/null

	      # Ask for the user's name and password if not yet known.
	      SPECTRE_FULLNAME=${SPECTRE_USERNAME:-$(ask 'Your Full Name:')}

	      # restart the gpaste-client daemon  because it has
	      # trouble keeping up with clipboard changes.
	      {
	          gpaste-client daemon-reexec

	      } >/dev/null 2>&1

	      # Start Master Password and copy the output. This is where the
	      # magic begins.
	      printf %s "$(SPECTRE_USERNAME=$SPECTRE_USERNAME command spectre -F n "$@")" | _copy

	      # For gpaste-client: clear last password after 30 seconds
	      if [[ "$_use" = "${_clips[2]}" ]]; then
            (
		            {
		                _name="spectre_$(mktemp -u XXXXXXXXXXXX)"
		                gpaste-client rename-password "" "$_name"
		                sleep 30
		                gpaste-client delete-password "$_name"

		            } >/dev/null 2>&1 &
	          )
	      fi
    fi
}

gpaste() {
    # syntactic sugar for gpaste-client
    #
    # usage: see gpaste-client man page
    #/usr/bin/gpaste-client daemon-reexec >/dev/null 2>&1

    /usr/bin/gpaste-client "$@"
    
}

clipc() {
    # Clear gpaste-client history
    gpaste-client empty
}

debug() {
    # crappy debug function

    set -x; "$@"; set +x
}

mpv() {
    # call mpv on a file and keep the display from sleeping
    local optimus="$(lspci | grep -E 'VGA|3D' | grep -E '[nN]vidia|NVIDIA')"
    
    play() {
	      # if nvidia optimus graphics card exists, use it
	      inhibit-lid-switch() {
	          # syntactic sugar
	          systemd-inhibit --what=handle-lid-switch /usr/bin/mpv "$@"
	      }
	      
	      if [[ -z "$optimus" ]]; then
	          inhibit-lid-switch "$@"
	      else
	          DRI_PRIME=1 inhibit-lid-switch "$@"
	      fi
    }
    
    play "$@" 
}

emacsctl() {
    # syntactic sugar for controlling emacs daemon.
    usage() {
	      printf "%s\n" "Usage: emacsctl {status|start|stop|restart|reload}"
    }
    
    case "$1" in
	      status|stop|start|restart)
	          systemctl --user "$1" emacs ;;
	      reload)
	          emacsctl restart ;;
	      *)
	          usage
    esac
}

mkpass() {
    # generate a 64 character random password
    
    printf "%s" "$(mktemp -u $(for i in {0..63}; do 
                                   printf "%s" "X"; 
                               done))" | gpaste-client

    printf "%s\n" "Password copied to clipboard"
}

mmtail() {
    # pass arbitrary number of files to multitail or
    # all files in a directory
    
    mt() {
	      declare -a file
	      for object in "$@"; do
	          if [[ -f "$file" ]]; then
		            files+=("$file ")
	          fi
	      done

	      multitail "${objects[@]}"
    }

    if [[ -z "$@" ]]; then
	      mt *
    else
	      mt "$@"
    fi
}

miotop() {
    # pass arbitrary amount of PIDs to iotop
    
    for pid in $(pgrep "$1"); do
	      pids+=( "--pid $pid " )
    done

    sudo iotop "${pids[@]}"
}

vmanage() {
    /usr/bin/vboxmanage "$@"
}

vterm_printf() {
    if [ -n "$TMUX" ] && ([ "${TERM%%-*}" = "tmux" ] || [ "${TERM%%-*}" = "screen" ] ); then
        # Tell tmux to pass the escape sequences through
        printf "\ePtmux;\e\e]%s\007\e\\" "$1"
    elif [ "${TERM%%-*}" = "screen" ]; then
        # GNU screen (screen, screen-256color, screen-256color-bce)
        printf "\eP\e]%s\007\e\\" "$1"
    else
        printf "\e]%s\e\\" "$1"
    fi
}

pkg-search () {
	version="$(uname -a | cut -d ' ' -f 3 | cut -d '.' -f 4 | tr -d 'a-z')"

	sudo podman run --rm fedora:"$version" dnf search "$@"

}

